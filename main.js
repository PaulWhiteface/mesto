(()=>{"use strict";const e=class{constructor(e,t){let{inputSelector:s,submitButtonSelector:r,inactiveButtonClass:i,inputErrorClass:n,errorClass:o}=t;this._form=e,this._inputSelector=s,this._submitButtonSelector=r,this._inactiveButtonClass=i,this._inputErrorClass=n,this._errorClass=o}enableValidation(){this._inputs=Array.from(this._form.querySelectorAll(this._inputSelector)),this._formButton=this._form.querySelector(this._submitButtonSelector),this._form.addEventListener("submit",(e=>{e.preventDefault()})),this._handleInput()}_handleInput(){this._inputs.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._hasInvalidInput()?this.disableButton():this._enableButton()}))}))}_hasInvalidInput(){return this._inputs.some((e=>!e.validity.valid))}_checkInputValidity(e){const t=e.getAttribute("name"),s=document.getElementById(`${t}-error`);e.validity.valid?this._removeError(e,s):this._showError(e,s)}_showError(e,t){t.textContent=e.validationMessage,t.classList.add(this._errorClass),e.classList.add(this._inputErrorClass)}_removeError(e,t){t.textContent="",t.classList.remove(this._errorClass),e.classList.remove(this._inputErrorClass)}disableButton(){this._formButton.classList.add(this._inactiveButtonClass),this._formButton.setAttribute("disabled",!0)}_enableButton(){this._formButton.classList.remove(this._inactiveButtonClass),this._formButton.removeAttribute("disabled")}resetValidationErrors(){this._inputs.forEach((e=>{const t=e.getAttribute("name"),s=document.getElementById(`${t}-error`);this._removeError(e,s)}))}};class t{constructor(e){this._popupElement=document.querySelector(e),this._closeButton=this._popupElement.querySelector(".popup__close"),this._handleEscClose=this._handleEscClose.bind(this)}_handleEscClose(e){"Escape"===e.key&&this.close()}_handleOverlayClose(e){e.target===e.currentTarget&&this.close()}open(){this._popupElement.classList.add("popup_active"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popupElement.classList.remove("popup_active"),document.removeEventListener("keydown",this._handleEscClose)}setEventListeners(){this._closeButton.addEventListener("click",(()=>this.close())),this._popupElement.addEventListener("mousedown",(e=>this._handleOverlayClose(e)))}}class s extends t{constructor(e,t){let{submit:s}=t;super(e),this._form=this._popupElement.querySelector(".popup__form"),this._inputs=Array.from(this._form.querySelectorAll(".popup__input")),this._submitButton=this._form.querySelector(".popup__button"),this._submit=s}_getInputValues(){return this._inputObj={},this._inputs.forEach((e=>{this._inputObj[e.name]=e.value})),this._inputObj}setInputValues(e){this._inputs.forEach((t=>{t.value=e[t.name]}))}setEventListeners(){this._form.addEventListener("submit",(e=>{e.preventDefault(),this._submit(this._getInputValues())})),super.setEventListeners()}close(){this._form.reset(),super.close()}rendering(e){this._submitButton.textContent=e?"Сохранение...":"Сохраненить"}}const r={inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disable",inputErrorClass:"popup__input_error",errorClass:"popup__error_visible"},i=document.querySelector(".profile__button-name"),n=document.querySelector(".profile__button-photo"),o=document.querySelector(".popup__form-profile"),a=document.querySelector(".popup__form-card"),l=document.querySelector(".profile__change-image"),h=document.querySelector(".popup__form-avatar"),c=new class{constructor(e){this._baseUrl=e.baseUrl,this._headers=e.headers}_checkResponse(e){return e.ok?e.json():Promise.reject(`Ошибка ${e.status}`)}getInitialCards(){return fetch(this._baseUrl+"/cards",{headers:this._headers}).then(this._checkResponse)}getUserInfoFromServer(){return fetch(this._baseUrl+"/users/me",{headers:this._headers}).then(this._checkResponse)}setUserInfoOnServer(e,t){return fetch(this._baseUrl+"/users/me",{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e,about:t})}).then(this._checkResponse)}setProfileAvatar(e){return fetch(this._baseUrl+"/users/me/avatar",{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e})}).then(this._checkResponse)}addCardByHandle(e,t){return fetch(this._baseUrl+"/cards",{method:"POST",headers:this._headers,body:JSON.stringify({name:e,link:t})}).then(this._checkResponse)}handleDeleteCard(e){return fetch(this._baseUrl+`/cards/${e}`,{method:"DELETE",headers:this._headers}).then(this._checkResponse)}setLikeOnCard(e){return fetch(this._baseUrl+`/cards/${e}/likes`,{method:"PUT",headers:this._headers}).then(this._checkResponse)}removeLikeOnCard(e){return fetch(this._baseUrl+`/cards/${e}/likes`,{method:"DELETE",headers:this._headers}).then(this._checkResponse)}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-66",headers:{authorization:"2339a9f7-9e2a-43f5-90b5-72dfb8a8fa78","Content-Type":"application/json"}});let _="";Promise.all([c.getUserInfoFromServer(),c.getInitialCards()]).then((e=>{let[t,s]=e;_=t._id,m.setAvatar(t.avatar),m.setUserInfo(t.name,t.about),L.renderItems(s)})).catch((e=>{console.log(e)}));const d=new e(o,r),u=new e(a,r),p=new e(h,r),m=new class{constructor(e){let{nickname:t,job:s,avatar:r}=e;this._name=document.querySelector(t),this._job=document.querySelector(s),this._avatar=document.querySelector(r)}getUserInfo(){return{nickname:this._name.textContent,job:this._job.textContent}}setUserInfo(e,t){this._name.textContent=e,this._job.textContent=t}setAvatar(e){this._avatar.src=e}}({nickname:".profile__name",job:".profile__description",avatar:".profile__image"}),v=new s(".popup-profile",{submit:function(e){v.rendering(!0),c.setUserInfoOnServer(e.nickname,e.job).then((e=>{m.setUserInfo(e.name,e.about),v.close()})).catch((e=>{console.log(e)})).finally((()=>{v.rendering(!1)}))}});v.setEventListeners(),i.addEventListener("click",(()=>{v.setInputValues(m.getUserInfo()),d.disableButton(),d.resetValidationErrors(),v.open()}));const b=new s(".popup-avatar",{submit:function(e){b.rendering(!0),c.setProfileAvatar(e.avatarlink).then((e=>{m.setAvatar(e.avatar),b.close()})).catch((e=>{console.log(e)})).finally((()=>{b.rendering(!1)}))}});b.setEventListeners(),l.addEventListener("click",(()=>{p.disableButton(),p.resetValidationErrors(),b.open()}));const k=new class extends t{constructor(e){super(e),this._imageInPopup=this._popupElement.querySelector(".popup__image"),this._textInPopup=this._popupElement.querySelector(".popup__image-text")}open(e){this._imageInPopup.src=e.link,this._imageInPopup.alt=e.name,this._textInPopup.textContent=e.name,super.open()}}(".popup-image");k.setEventListeners();const f=new s(".popup-card",{submit:e=>{f.rendering(!0),c.addCardByHandle(e.name,e.link).then((e=>{L.setItem(C(e)),f.close()})).catch((e=>{console.log(e)})).finally((()=>{f.rendering(!1)}))}});function C(e){const t=new class{constructor(e,t,s,r){let{handleCardClick:i,handleCardDelete:n,handleCardLike:o}=r;this._name=e.name,this._link=e.link,this._likes=e.likes,this._id=e._id,this._owner=e.owner._id,this._myId=t,this._templateSelector=s,this._handleCardClick=i,this._handleCardDelete=n,this._handleCardLike=o}_getTemplate(){return document.querySelector(this._templateSelector).content.querySelector(".card").cloneNode(!0)}createCard(){return this._element=this._getTemplate(),this._cardImage=this._element.querySelector(".card__photo"),this._cardText=this._element.querySelector(".card__text"),this._cardLike=this._element.querySelector(".card__button"),this._cardDeleteButton=this._element.querySelector(".card__delete"),this._likeLength=this._element.querySelector(".card__item-like-container"),this._setEventListeners(),this._cardImage.src=this._link,this._cardImage.alt=this._name,this._cardText.textContent=this._name,this._likeLength.textContent=this._likes.length,this._cardLikeChecker(),this._myId!==this._owner&&this._cardDeleteButton.classList.add("card__delete_disable"),this._element}handleDelete(){this._element.remove()}_likeActive(){this._cardLike.classList.add("card__button_active")}_likeDisable(){this._cardLike.classList.remove("card__button_active")}_setEventListeners(){this._cardImage.addEventListener("click",this._handleCardClick),this._cardDeleteButton.addEventListener("click",(()=>{this._handleCardDelete(this._id)})),this._cardLike.addEventListener("click",(()=>{this._handleCardLike(this._id)}))}isLiked(){return this._likes.some((e=>e._id===this._myId))}showCardLikes(e){this._likes=e,this._likeLength.textContent=this._likes.length,this._cardLikeChecker()}_cardLikeChecker(){this.isLiked()?this._likeActive():this._likeDisable()}}(e,_,".template-card",{handleCardClick:()=>{k.open(e)},handleCardDelete:e=>{E.open(),E.submitDelete((()=>{c.handleDeleteCard(e).then((e=>{t.handleDelete(e),E.close()})).catch((e=>{console.log(e)}))}))},handleCardLike:e=>{t.isLiked()?c.removeLikeOnCard(e).then((e=>{t.showCardLikes(e.likes)})).catch((e=>{console.log(e)})):c.setLikeOnCard(e).then((e=>{t.showCardLikes(e.likes)})).catch((e=>{console.log(e)}))}});return t.createCard()}f.setEventListeners(),n.addEventListener("click",(()=>{u.disableButton(),u.resetValidationErrors(),f.open()})),d.enableValidation(),u.enableValidation(),p.enableValidation();const E=new class extends t{constructor(e){super(e),this._formDelete=this._popupElement.querySelector(".popup__form")}setEventListeners(){this._formDelete.addEventListener("submit",(e=>{e.preventDefault(),this._submit(this)})),super.setEventListeners()}submitDelete(e){this._submit=e}}(".popup-delete");E.setEventListeners();const L=new class{constructor(e,t){let{renderer:s}=e;this._renderer=s,this._container=document.querySelector(t)}setItem(e){this._container.prepend(e)}renderItems(e){e.forEach((e=>{this._renderer(e)}))}}({renderer:e=>{L.setItem(C(e))}},".elements__grid")})();